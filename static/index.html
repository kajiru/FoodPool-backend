<html>
<head>
  <title>Payment Form</title>
  <script type="text/javascript" src="https://js.squareup.com/v2/paymentform"></script>
  <script>
    var sqPaymentForm = new SqPaymentForm({

      // Replace this value with your application's ID (available from the merchant dashboard).
      // If you're just testing things out, replace this with your _Sandbox_ application ID,
      // which is also available there.
      applicationId: 'sandbox-sq0idp-R21hfTdwB0CPoGpL5JdsyQ',
      inputClass: 'sq-input',
      cardNumber: {
        elementId: 'sq-card-number',
        placeholder: "0000 0000 0000 0000"
      },
      cvv: {
        elementId: 'sq-cvv',
        placeholder: 'CVV'
      },
      expirationDate: {
        elementId: 'sq-expiration-date',
        placeholder: 'MM/YY'
      },
      postalCode: {
        elementId: 'sq-postal-code',
        placeholder: 'Postal Code'
      },
      inputStyles: [

        // Because this object provides no value for mediaMaxWidth or mediaMinWidth,
        // these styles apply for screens of all sizes, unless overridden by another
        // input style below.
        {
          fontSize: '14px',
          padding: '3px'
        },

        // These styles are applied to inputs ONLY when the screen width is 400px
        // or smaller. Note that because it doesn't specify a value for padding,
        // the padding value in the previous object is preserved.
        {
          mediaMaxWidth: '400px',
          fontSize: '18px',
        }
      ],
      callbacks: {
        cardNonceResponseReceived: function(errors, nonce, cardData) {
          if (errors) {
            var errorDiv = document.getElementById('errors');
            errorDiv.innerHTML = "";
            errors.forEach(function(error) {
              var p = document.createElement('p');
              p.innerHTML = error.message;
              errorDiv.appendChild(p);
            });
          } else {
            // This alert is for debugging purposes only.
            //alert('Nonce received! ' + nonce + ' ' + JSON.stringify(cardData));

            // Assign the value of the nonce to a hidden form element
            var nonceField = document.getElementById('card-nonce');
            nonceField.value = nonce;
            // Submit the form
            document.getElementById('form').submit();
          }
        },
        unsupportedBrowserDetected: function() {
          // Alert the buyer that their browser is not supported
        }
      }
    });
    function submitButtonClick(event) {
      event.preventDefault();
      //validateUserInfo();
      sqPaymentForm.requestCardNonce();
    }


    //alert(restaurantMenu.options[restaurantMenu.selectedIndex ].value);


    function validateUserInfo(){
      //TODO: Actually check various constrains
      var name = document.querySelector('input[name="name"]').value;
      var order = document.querySelector('input[name="order"]').value;
      var cost = document.querySelector('input[name="cost"]').value;
      var phone = document.querySelector('input[name="phoneNumber"]').value;
    }

  </script>
  <style type="text/css">
    .sq-input {
      border: 1px solid #CCCCCC;
      margin-bottom: 10px;
      padding: 1px;
    }
    .sq-input--focus {
      outline-width: 5px;
      outline-color: #70ACE9;
      outline-offset: -1px;
      outline-style: auto;
    }
    .sq-input--error {
      outline-width: 5px;
      outline-color: #FF9393;
      outline-offset: 0px;
      outline-style: auto;
    }
  </style>
</head>
<body>

  <h1>Place Your Order</h1>

  <form id="form" novalidate action="/processOrder" method="post">

    <label>Name </label><br>
    <input type="text" name="username">
    <br>
    <label>Select Restraunt</label>
    <br>
    <select id ="restaurantName" onchange="updateMenus(this)">
      <option value="chipotle">Chipotle</option>
      <option value="in-n-out">In-N-Out</option>
      <option value="panda-express">Panda Express</option>
      <option value="great-chinese">Great Chine</option>
      <option value="thai-Basil-Cuisine">Thai Basil Cuisine</option>
    </select>
    <br>
    <div id = "meals">
      <label>Select Meal</label>
      <br>
      <select id="mealsList" name="mealChoise">
        <option value="7.15" >Chiecken Burrito Bowl - $7.15</option>
        <option value="8.25">Steak Burrito Bowl - $8.25</option>
        <option value="7.15"> Veggie Burrito - $7.15</option>
      </select>
    </div>
    <label>Total Cost</label><br>
    <input type="text" name="cost" value="$9.15">
    <br>
    <label>Phone number </label><br>
    <input type="text" name="phoneNumber">
    <br>

    <label>Credit Card</label>
    <div id="sq-card-number"></div>
    <label>CVV</label>
    <div id="sq-cvv"></div>
    <label>Expiration Date</label>
    <div id="sq-expiration-date"></div>
    <label>Postal Code</label>
    <div id="sq-postal-code"></div>
    <input type="hidden" id="card-nonce" name="nonce">
    <input type="submit" onclick="submitButtonClick(event)" id="card-nonce-submit">
  </form>

  <div id="errors">
  </div>

  <script>

  function updateMenus(el){
    var restaurants = [
      [{meal:'Chicken Burrito Bowl - Chicken',price: 7.15},{meal:'Steak Burrito Bowl',price: 8.25},{meal:'Veggie Burrito ',price: 7.15}],
      [{meal:'Humburger w/Onion',price:5.25},{meal:'Cheeseburger w/Onion',price:5.55},{meal:'Double-Double w/Onion',price:6.60}]
    ];

    var mealsDiv = document.getElementById('meals');
    var value = el.options[el.selectedIndex].value;
    if(value === 'chipotle'){
      var chipotleMenu = restaurants[0];

      document.querySelector('input[name="cost"]').value = '$' + (parseFloat(chipotleMenu[0]['price']) + 2.0);
      var chipotleMenuArr = [];
      for(var i = 0; i < chipotleMenu.length; i++){
        chipotleMenuArr.push(tag('option', {'value':chipotleMenu[i]['price']},chipotleMenu[i]['meal'] + ' - $' + chipotleMenu[i]['price']));
      }
      meals.innerHTML = '';
      meals.appendChild(tag('label',{},'Select Meal'));
      meals.appendChild(tag('br',{},''));
      mealsDiv.appendChild(tag('select',{'id':'mealsList'},chipotleMenuArr));

      //Reattaches the event listener
      var mealsList = document.getElementById('mealsList');
      mealsList.addEventListener('change', event =>{
        event.preventDefault();
        mealsList = document.querySelector('#mealsList');
        var totalCostDiv = document.querySelector('input[name="cost"]');
        console.log((parseFloat(mealsList.options[mealsList.selectedIndex].value) + 2));
        totalCostDiv.value = '$' + (parseFloat(mealsList.options[mealsList.selectedIndex].value) + 2);
      });

    }else{
      var othersMenu = restaurants[1];
      document.querySelector('input[name="cost"]').value = '$' + (parseFloat(othersMenu[0]['price']) +2.0);
      var othersMenuArr = [];
      for(var i = 0; i < othersMenu.length; i++){
        othersMenuArr.push(tag('option', {'value':othersMenu[i]['price']},othersMenu[i]['meal'] + ' - $' + othersMenu[i]['price']));
      }
      meals.innerHTML = '';
      meals.appendChild(tag('label',{},'Select Meal'));
      meals.appendChild(tag('br',{},''));
      mealsDiv.appendChild(tag('select',{'id':'mealsList'},othersMenuArr));

      //Reattaches the event listener
      var mealsList = document.getElementById('mealsList');
      mealsList.addEventListener('change', event =>{
        event.preventDefault();
        mealsList = document.querySelector('#mealsList');
        var totalCostDiv = document.querySelector('input[name="cost"]');
        console.log((parseFloat(mealsList.options[mealsList.selectedIndex].value) + 2));
        totalCostDiv.value = '$' + (parseFloat(mealsList.options[mealsList.selectedIndex].value) + 2);
      });
    }

  }

    var mealsList = document.getElementById('mealsList');
    mealsList.addEventListener('change', event =>{
      event.preventDefault();
      mealsList = document.querySelector('#mealsList');
      var totalCostDiv = document.querySelector('input[name="cost"]');
      console.log((parseFloat(mealsList.options[mealsList.selectedIndex].value) + 2));
      totalCostDiv.value = '$' + (parseFloat(mealsList.options[mealsList.selectedIndex].value) + 2);

    });


  function tag(name, attrs, contents) {
    const element = document.createElement(name)
    for (const name in attrs) {
      element.setAttribute(name, attrs[name])
    }

    // If contents is a single string or HTMLElement, make it an array of one
    // element; this guarantees that contents is an array below.
    if (!(contents instanceof Array)) {
      contents = [contents]
    }

    contents.forEach(piece => {
      if (piece instanceof HTMLElement) {
        element.appendChild(piece)
      } else {
        // must create a text node for a raw string
        element.appendChild(document.createTextNode(piece))
      }
  })
    return element
  }
  </script>
</body>
</html>
